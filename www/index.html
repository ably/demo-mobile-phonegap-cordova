<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ably.io sample chat application</title>
    <link href="styles.css" rel="stylesheet" type="text/css"/>

    <script src="http://cdn.ably.io/lib/ably.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script src="app.js"></script>
</head>
<body>

<div id="loading-overlay">
    <span id="loading-message"></span>
</div>

<div id="enter-name-view">
    <form id="name-form">
        <input type="text" placeholder="Name" id="name"/>
        <input type="submit" id="submit-name" value="Submit"/>
    </form>
</div>

<div id="main-app-view">
    <div class="modal-overlay">
        <p id="status-message"></p>
    </div>

    <form id="message-form" action="#">
        <div class="chat-box">
            <input type="text" id="message-text" placeholder="Message"/>
            <input type="submit" id="submit-message" value="Submit"/>
        </div>
    </form>

    <ul id="message-list">

    </ul>
</div>

<script>
    function UiController($messageList, $loadingOverlay, $loadingMessage) {
        function showMessage(message) {
            var $li = $('<li></li>');
            $li.addClass('chat-message');
            $li.html('[' + new Date(message.timestamp).toISOString() + '] '
                    + message.name
                    + ': '
                    + message.text);
            $messageList.append($li);
        }

        function showPresence(presence) {
            var $li = $('<li></li>');
            $li.addClass('presence-message');
            $li.html(presence.name + ' has ' + presence.action + ' the channel.');
            $messageList.append($li);
        }

        return {
            onMessageReceived: function (message) {
                showMessage({
                    name: message.data.name,
                    text: message.data.text,
                    timestamp: message.timestamp
                });
            },
            onError: function (err) {
                if (err) {
                    if (err.message) {
                        alert(err.message);
                    }
                    else {
                        alert(JSON.stringify(err));
                    }
                }
            },
            onPresence: function (presenceMessage) {
                var actionText;
                if (presenceMessage.action === Ably.Realtime.PresenceMessage.Action.ENTER) {
                    actionText = 'entered';
                }
                if (presenceMessage.action === Ably.Realtime.PresenceMessage.Action.LEAVE) {
                    actionText = 'left';
                }
                showPresence({name: presenceMessage.clientId, action: actionText});
            },

            showLoadingOverlay: function (message) {
                $loadingOverlay.show();
                if (message) {
                    $loadingMessage.text(message);
                }
            },

            hideLoadingOverlay: function () {
                $loadingOverlay.hide();
                $loadingMessage.text('');
            }
        }
    }

    $(document).ready(function () {
        var $mainAppView = $('#main-app-view');
        var $messageText = $('#message-text');
        var $name = $('#name');
        var $nameForm = $('#name-form');
        var $messageForm = $('#message-form');
        var $messageList = $('#message-list');
        var $loadingOverlay = $('#loading-overlay');
        var $loadingMessage = $('#loading-message');

        $mainAppView.hide();

        var uiController = new UiController($messageList, $loadingOverlay, $loadingMessage);
        var app = new ChatApp(uiController);

        uiController.showLoadingOverlay('Loading...');
        app.initialize(function () {
            uiController.hideLoadingOverlay();
        });

        $nameForm.on('submit', function (ev) {
            ev.preventDefault();

            $('#enter-name-view').hide();
            $('#main-app-view').show();

            app.joinChannel($name.val());
        });

        $messageForm.on('submit', function (ev) {
            ev.preventDefault();
            app.publishMessage($messageText.val());
            $messageText.val('');
            $messageText.focus();
        });
    });
</script>

</body>
</html>