<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy"
          content="default-src *; style-src *; media-src *; script-src * 'unsafe-inline'">
    <title>Ably.io sample chat application</title>
    <link href="css/styles.css" rel="stylesheet" type="text/css"/>

    <script src="http://cdn.ably.io/lib/ably.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://underscorejs.org/underscore.js"></script>
    <script src="http://build.origami.ft.com/bundles/js?modules=fastclick"></script>

    <script src="js/app.js"></script>
    <script src="js/uiController.js"></script>
    <script src="js/utils.js"></script>

    <script>
        // Load Cordova.js only if running on mobile
        window.isRunningOnMobile = document.URL.indexOf('http://') === -1 && document.URL.indexOf('https://') === -1;

        if (window.isRunningOnMobile) {
            var cordovaScriptTag = decodeURI('%3Cscript src="cordova.js"%3E%3C/script%3E');
            document.write(cordovaScriptTag);
        }
    </script>
</head>
<body>

<div id="loading-overlay" class="hidden">
    <span id="loading-message"></span>
</div>

<div id="enter-name-view">
    <form id="name-form">
        <input type="text" placeholder="Name" id="name" class="name-input"/>
        <input type="submit" id="submit-name" value="Submit"/>
    </form>
</div>

<div id="main-app-view" class="hidden">

    <div id="message-list">

    </div>

    <span id="members-typing-indication"></span>
    <span id="connection-info"></span>

    <div class="message-back">
        <a class="members-lozenge" href="javascript:void(0)">
            <img src="images/avatars.png" width="32"/>
            <span class="members-count"></span>
        </a>

        <form id="message-form" action="#">
            <div class="chat-box">
                <input type="text" id="message-text" class="message-input" placeholder="Message"/>
                <input type="submit" id="submit-message" class="message-send" value="Submit"/>
            </div>
        </form>
    </div>
</div>

<div class="hidden members-list-popup">
    <a class="dialog-close" id="dialog-close"></a>

    <h1>Members present</h1>
    <h5>Click a user to @ mention them</h5>
    <ul class="members-list">
    </ul>
</div>

<script>
    $(document).ready(function () {
        Origami.fastclick(document.body);
        var $mainAppView = $('#main-app-view');
        var $enterNameView = $('#enter-name-view');
        var $messageText = $('#message-text');
        var $name = $('#name');
        var $nameForm = $('#name-form');
        var $messageForm = $('#message-form');
        var $membersLozenge = $mainAppView.find('.members-lozenge');
        var $membersListPopup = $('.members-list-popup');
        var $dialogCloseButton = $('#dialog-close');

        var uiController = new UiController();
        var app = new ChatApp(uiController);

        uiController.showLoadingOverlay();
        
        // Cordova handlers for app pause and app resume
        // * disconnect when moving to background
        // * connect back to Ably when moving back to the foreground
        var initializeApp = function () {
            app.initialize(function () {
                uiController.hideLoadingOverlay();

                document.addEventListener('pause', function () {
                    app.disconnect();
                });

                document.addEventListener('resume', function () {
                    app.connect();
                });
            });
        };

        if (window.isRunningOnMobile) {
            document.addEventListener('deviceready', initializeApp);
        }
        else {
            initializeApp();
        }

        // Joins the channel using the name entered by the user
        $nameForm.on('submit', function (ev) {
            ev.preventDefault();

            $enterNameView.hide();
            $mainAppView.show();

            uiController.showLoadingOverlay();
            app.joinChannel($name.val(), uiController.hideLoadingOverlay);
        });

        // Sends the message typed by the user and stops the 'user is typing' notification
        $messageForm.on('submit', function (ev) {
            ev.preventDefault();

            if ($messageText.val().trim() === '') {
                return;
            }

            app.publishMessage($messageText.val());
            $messageText.val('');
            $messageText.focus();

            app.sendTypingNotification(false);
        });

        // Sends a 'user is typing' notification, except when completing a message via the Enter key.
        $messageText.on('keydown', function (e) {
            if (e.keyCode == 13) {
                return;
            }

            app.sendTypingNotification(true);
        });

        // Sends a 'user has stopped typing' notification, after 2 seconds have passed since the last keystroke.
        $messageText.on('keyup', _.debounce(function () {
            app.sendTypingNotification(false);
        }, 2000));

        $membersLozenge.on('click', function () {
            $membersListPopup.show();
        });

        $dialogCloseButton.on('click', function () {
            $membersListPopup.hide();
        });

        $(window).unload(function () {
            app.disconnect();
        });
    });
</script>

</body>
</html>
