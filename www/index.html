<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ably.io sample chat application</title>
    <link href="css/styles.css" rel="stylesheet" type="text/css"/>

    <script src="http://cdn.ably.io/lib/ably.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://underscorejs.org/underscore.js"></script>
    <script src="js/app.js"></script>
    <script src="js/uiController.js"></script>
    <script src="js/utils.js"></script>
</head>
<body>

<div id="loading-overlay" class="hidden">
    <span id="loading-message"></span>
</div>

<div id="enter-name-view">
    <form id="name-form">
        <input type="text" placeholder="Name" id="name"/>
        <input type="submit" id="submit-name" value="Submit"/>
    </form>
</div>

<div id="main-app-view" class="hidden">

    <ul id="message-list">

    </ul>

    <span id="members-typing-indication"></span>

    <div>
        <a class="members-lozenge" href="javascript:void(0)">
            <img src="images/avatars.png" width="32"/>
            <span class="members-count"></span>
        </a>

        <form id="message-form" action="#">
            <div class="chat-box">
                <input type="text" id="message-text" placeholder="Message"/>
                <input type="submit" id="submit-message" value="Submit"/>
            </div>
        </form>
    </div>
</div>

<div class="hidden members-list-popup">
    <ul class="members-list">
    </ul>
</div>

<script>
    $(document).ready(function () {
        var $mainAppView = $('#main-app-view');
        var $enterNameView = $('#enter-name-view');
        var $messageText = $('#message-text');
        var $name = $('#name');
        var $nameForm = $('#name-form');
        var $messageForm = $('#message-form');
        var $membersLozenge = $mainAppView.find('.members-lozenge');
        var $membersListPopup = $('.members-list-popup');

        var uiController = new UiController();
        var app = new ChatApp(uiController);

        uiController.showLoadingOverlay();
        app.initialize(function () {
            uiController.hideLoadingOverlay();
        });

        $nameForm.on('submit', function (ev) {
            ev.preventDefault();

            $enterNameView.hide();
            $mainAppView.show();

            uiController.showLoadingOverlay();
            app.joinChannel($name.val(), uiController.hideLoadingOverlay);
        });

        $messageForm.on('submit', function (ev) {
            ev.preventDefault();
            app.publishMessage($messageText.val());
            $messageText.val('');
            $messageText.focus();

            app.sendTypingNotification(false);
        });

        $messageText.on('keydown', _.throttle(function () {
            app.sendTypingNotification(true);
        }, 5000));

        $messageText.on('keyup', _.debounce(function () {
            app.sendTypingNotification(false);
        }, 5000));

        $membersLozenge.on('click', function () {
            $membersListPopup.show();
        });
    });
</script>

</body>
</html>
